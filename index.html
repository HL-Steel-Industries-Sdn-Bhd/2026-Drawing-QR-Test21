<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drawing + Work Entry Demo</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
    * { box-sizing: border-box; margin:0; padding:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
    .container { background:white; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.2); width:100%; max-width:1400px; padding:30px; margin: 0 auto; }
    h2 { color:#333; text-align:center; margin-bottom:30px; font-size:28px; font-weight:600; }
    
    /* ===== é‡æ–°è®¾è®¡çš„ç¬¬ä¸€é¡µå¸ƒå±€ ===== */
    .drawing-content {
        display: flex;
        flex-direction: column;
    }
    
    @media (min-width: 768px) {
        .drawing-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: stretch;
        }
        
        .drawing-info, .scan-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
    }
    
    /* å›¾çº¸ä¿¡æ¯å¡ç‰‡æ ·å¼ - é‡æ–°è®¾è®¡ */
    .drawing-card { 
        background:#f8f9fa; 
        border-radius:8px; 
        padding:25px; 
        border-left:4px solid #667eea; 
        box-shadow:0 5px 15px rgba(0,0,0,0.05);
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    /* æ–°çš„è¡¨å•ç½‘æ ¼å¸ƒå±€ - å‚è€ƒæä¾›çš„æ ·å¼ */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 15px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group.full-width {
        grid-column: 1 / -1;
    }
    
    .form-label {
        font-weight: 500;
        color: #555;
        margin-bottom: 6px;
        font-size: 14px;
        display: flex;
        align-items: center;
    }
    
    .form-label:before {
        content: "â€¢";
        color: #667eea;
        margin-right: 6px;
        font-weight: bold;
    }
    
    .form-value {
        padding: 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 15px;
        color: #333;
        font-weight: 500;
        min-height: 44px;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s;
    }
    
    .form-value:hover {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102,126,234,0.1);
    }
    
    /* æ‰‹æœºç‰ˆ - å‡å°‘é—´è· */
    @media (max-width: 767px) {
        .drawing-card { 
            padding:15px; 
            margin-bottom:15px; 
        }
        
        .form-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        h2 {
            margin-bottom:20px;
            font-size:24px;
        }
        
        .container {
            padding:20px;
        }
    }
    
    /* æ‰«æåŒºåŸŸæ ·å¼ */
    .scan-section {
        background:#f8f9fa; 
        border-radius:8px; 
        padding:25px; 
        text-align:center;
        border-left:4px solid #667eea;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .scan-instruction { 
        font-size:18px; 
        color:#667eea; 
        font-weight:600; 
        margin-bottom: 20px;
    }
    
    .scanner-container {
        width: 100%;
        height: 200px;
        border: 2px dashed #bbb;
        border-radius: 8px;
        position: relative;
        background-color: #f9f9f9;
        transition: all 0.3s ease;
        overflow: hidden;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    @media (min-width: 768px) {
        .scanner-container {
            width: 180px;
            height: 180px;
            margin: 0 auto 20px;
        }
    }
    
    @media (max-width: 767px) {
        .scanner-container {
            height: 250px;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .scan-section {
            padding:15px;
            margin-top: 15px;
        }
    }
    
    /* è™šçº¿æ¡†æ¡†æç¤º */
    .dashed-box {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #777;
        font-size: 14px;
    }
    
    #reader {
        width: 100%;
        height: 100%;
    }
    
    /* GIFå®¹å™¨ */
    .gif-container {
        text-align: center;
        margin-top: auto;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .gif-container p {
        margin-bottom: 10px;
        color:#555;
        font-size: 14px;
    }
    
    .gif-container img {
        width: 130px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* å·¥ä½œèµ„æ–™éƒ¨åˆ† */
    .work-section {
        display: none;
    }
    
    /* ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º */
    #userDisplay {
        background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 25px;
        font-size: 1.2rem;
        text-align: center;
        box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        font-weight: 600;
    }
    
    /* æ–°å¢ï¼šå›¾çº¸ä¿¡æ¯ä¸²è”æ¡† */
    #drawingInfoSummary {
        background: #f8f9fa;
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0 25px 0;
        font-size: 16px;
        color: #333;
        line-height: 1.5;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    
    /* ç”µè„‘ç‰ˆæ–°å¸ƒå±€ */
    @media (min-width: 768px) {
        .work-main-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 30px;
            align-items: start;
            position: relative;
        }
        
        .cards-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: sticky;
            top: 20px;
            transition: top 0.3s ease;
            z-index: 10;
            align-self: flex-start;
        }
        
        .info-sidebar {
            position: sticky;
            top: 20px;
            transition: top 0.3s ease;
            z-index: 10;
            align-self: flex-start;
        }
        
        .stack-section {
            display: flex;
            flex-direction: column;
        }
    }
    
    /* æ‰‹æœºç‰ˆå¸ƒå±€ */
    @media (max-width: 767px) {
        .work-main-container {
            display: flex;
            flex-direction: column;
        }
        
        .cards-section {
            order: 3;
            margin-top: 30px;
        }
        
        .stack-section {
            order: 4;
        }
        
        .info-sidebar {
            order: 2;
            margin-top: 20px;
        }
    }
    
    /* å¡ç‰‡æ ·å¼ - ä½¿ç”¨æ–°é¢œè‰² */
    .card-box {
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        transition: all 0.3s ease;
        color: #333;
        text-align: center;
        padding: 20px;
        height: 140px; /* å¢åŠ é«˜åº¦ä»¥æ˜¾ç¤ºæ›´å¤šä¿¡æ¯ */
        border: 2px solid transparent;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    
    .card-box:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .card-box.selected {
        border-color: #333;
        box-shadow: 0 0 0 3px rgba(102,126,234,0.3), 0 8px 20px rgba(0,0,0,0.15);
    }
    
    /* ä½¿ç”¨æ–°é¢œè‰² */
    .c1 { background: #FFD5D5; } /* çº¢è‰² - Received From */
    .c2 { background: #D7F4F9; } /* è“è‰² - Job Completed */
    .c3 { background: #EBD8FF; } /* ç´«è‰² - Quality Control */
    
    .card-english {
        font-size: 20px;
        margin-bottom: 5px;
    }
    
    .card-chinese {
        font-size: 15px;
        font-weight: normal;
        margin-bottom: 10px;
    }
    
    /* ç”¨æˆ·é€‰æ‹©æ˜¾ç¤º - ä¿®æ”¹ï¼šç™½æ¡å»¶é•¿ä»¥æ˜¾ç¤ºæ›´å¤šå­—æ¯ */
    .user-selection {
        font-size: 13px;
        font-weight: normal;
        color: #333; /* æ”¹ä¸ºæ·±è‰²æ–‡å­— */
        background: rgba(255, 255, 255, 0.9); /* ç¨å¾®é€æ˜çš„ç™½è‰²èƒŒæ™¯ */
        padding: 5px 10px;
        border-radius: 4px;
        margin-top: 5px;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        height: 24px;
        min-width: 180px; /* ä»150pxå¢åŠ åˆ°180pxï¼Œå»¶é•¿ç™½æ¡ */
        text-align: center;
        border: 1px solid rgba(0,0,0,0.1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* å†…å®¹iframeåŒºåŸŸ */
    .content-frame {
        width: 100%;
        min-height: 400px;
        border-radius: 10px;
        border: 2px solid #ddd;
        background: #fff;
        padding: 25px;
        overflow-y: auto; /* ä¿æŒæ»šåŠ¨ï¼Œä½†ä¸è¦é™åˆ¶æœ€å¤§é«˜åº¦ */
    }
    
    .content-frame:focus {
        outline: none;
    }
    
    .frame-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
    }
    
    /* é€‰é¡¹æ ·å¼ - ä¿®å¤ç‰ˆ */
    .option-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 12px;
        padding: 12px;
        border-radius: 8px;
        transition: all 0.2s;
        background: #f9f9f9;
        cursor: pointer;
        position: relative;
        border: 1px solid transparent;
    }
    
    .option-item:hover {
        background-color: #f0f0f0;
        border-color: #ccc;
    }
    
    .option-item.selected {
        background-color: #e8f4ff;
        border-color: #667eea;
    }
    
    /* å®Œå…¨è‡ªå®šä¹‰å•é€‰æŒ‰é’® */
    .custom-radio {
        margin-right: 12px;
        margin-top: 3px;
        width: 18px;
        height: 18px;
        border: 2px solid #667eea;
        border-radius: 50%;
        background: white;
        position: relative;
        cursor: pointer;
        flex-shrink: 0;
    }
    
    .custom-radio.selected::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 8px;
        height: 8px;
        background: #667eea;
        border-radius: 50%;
    }
    
    .option-label {
        flex: 1;
        cursor: pointer;
    }
    
    .option-english {
        font-size: 15px;
        color: #333;
        margin-bottom: 3px;
        font-weight: 500;
    }
    
    .option-chinese {
        font-size: 13px;
        color: #666;
    }
    
    /* å¯†ç è¾“å…¥åŒºåŸŸ */
    .password-section {
        margin-top: 20px;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #ddd;
        width: 100%;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .password-input {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
        width: 100%;
    }
    
    /* ç§»åŠ¨ç«¯è°ƒæ•´ */
    @media (max-width: 767px) {
        .password-input {
            flex-direction: column;
        }
        
        .password-input button {
            width: 100%;
            margin-top: 10px;
        }
    }
    
    @media (min-width: 768px) {
        .password-input {
            flex-direction: column;
        }
        
        .password-input button {
            width: 100%;
            margin-top: 10px;
        }
    }
    
    .password-input input {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        width: 100%;
        box-sizing: border-box;
        cursor: text !important;
        pointer-events: auto !important;
    }
    
    .password-input button {
        padding: 12px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .password-input button:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
    }
    
    /* ä¿¡æ¯ä¾§è¾¹æ  */
    .info-sidebar {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border-left: 4px solid #667eea;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    @media (min-width: 768px) {
        .info-sidebar {
            height: fit-content;
            max-height: 400px;
        }
    }
    
    .sidebar-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .sidebar-item {
        margin-bottom: 15px;
    }
    
    .sidebar-label {
        font-weight: 500;
        color: #555;
        margin-bottom: 5px;
        font-size: 14px;
    }
    
    .sidebar-value {
        font-size: 15px;
        color: #333;
        font-weight: 500;
        background: white;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #eee;
    }
    
    /* æäº¤æŒ‰é’® */
    .submit-section {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    .submit-btn { 
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
        color:white; 
        border:none;
        padding:14px 40px; 
        border-radius:6px; 
        font-size:16px; 
        font-weight:600; 
        cursor:pointer; 
        transition:all 0.3s; 
        min-width: 200px;
    }
    
    .submit-btn:hover:not(:disabled) { 
        transform:translateY(-2px); 
        box-shadow:0 5px 15px rgba(102,126,234,0.4); 
    }
    
    .submit-btn:disabled { 
        background:#cccccc; 
        cursor: not-allowed;
    }
    
    .submit-btn:active:not(:disabled) { 
        transform:translateY(0); 
    }
    
    .success-message {
        margin-top: 15px;
        padding: 12px;
        background: #d4edda;
        color: #155724;
        border-radius: 6px;
        border: 1px solid #c3e6cb;
        display: none;
    }
    
    /* éšè—çš„æ‰«ç è¾“å…¥æ¡† */
    #scannerInput {
        opacity: 0;
        position: absolute;
        left: -9999px;
    }
    
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 600px) {
        .container { padding:15px; }
        h2 { font-size:22px; margin-bottom:15px; }
        .content-frame {
            min-height: 350px;
            padding: 15px;
        }
        .card-box {
            height: 130px;
            padding: 15px;
        }
        .card-english {
            font-size: 18px;
        }
        .card-chinese {
            font-size: 14px;
        }
        .user-selection {
            font-size: 12px;
            padding: 3px 6px;
            min-width: 150px; /* æ‰‹æœºç‰ˆä¹Ÿç›¸åº”å¢åŠ  */
        }
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .section {
        display: none;
    }
    
    #drawingSection {
        display: block;
    }
    
    /* æ–°å¢ï¼šç”µè„‘ç‰ˆæ‘„åƒå¤´åˆ‡æ¢æŒ‰é’®æ ·å¼ */
    .camera-toggle-container {
        margin: 15px 0;
        text-align: center;
    }
    
    .camera-toggle-btn {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin: 5px;
    }
    
    .camera-toggle-btn:hover {
        background: #45a049;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .camera-toggle-btn.stop {
        background: #f44336;
    }
    
    .camera-toggle-btn.stop:hover {
        background: #d32f2f;
    }
    
    .scanner-method {
        font-size: 14px;
        color: #666;
        margin-top: 10px;
        padding: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        display: inline-block;
    }
    
    /* æ–°å¢ï¼šç”µè„‘ç‰ˆæ‘„åƒå¤´æ‰«ææç¤º */
    .camera-instruction {
        font-size: 14px;
        color: #2196F3;
        margin: 10px 0;
        font-weight: 500;
    }
    
    .scanner-options {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }
    
    /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-not-started { background-color: #ccc; }
    .status-in-progress { background-color: #4CAF50; }
    
    /* æ–°å¢ï¼šç¡®è®¤æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal h3 {
        margin-bottom: 20px;
        color: #2c3e50;
        font-size: 24px;
    }
    
    .modal p {
        margin-bottom: 15px;
        color: #555;
        line-height: 1.5;
        text-align: left;
    }
    
    .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 25px;
    }
    
    .modal-btn {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 16px;
        min-width: 120px;
    }
    
    .modal-btn.yes {
        background: #2ecc71;
        color: white;
    }
    
    .modal-btn.no {
        background: #e74c3c;
        color: white;
    }
    
    .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .modal-btn:active {
        transform: translateY(0);
    }
    
    /* æ–°å¢ï¼šç¡®ä¿è¾“å…¥æ¡†å¯ç‚¹å‡» */
    #deficiencyText, #qcPassword {
        cursor: text !important;
        pointer-events: auto !important;
    }
    
    /* æ–°å¢ï¼šä¿®å¤Deficienciesè¾“å…¥æ¡†æ ·å¼ */
    #deficiencyInput {
        margin-top: 15px;
        padding: 15px;
        background: #fff;
        border-radius: 6px;
        border: 1px solid #ddd;
    }
    
    #deficiencyInput input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        cursor: text;
    }
    
    /* æ–°å¢ï¼šå¯†ç é”™è¯¯æç¤º */
    #passwordError {
        color: #e74c3c;
        font-size: 14px;
        margin-top: 10px;
        text-align: center;
    }
    
    /* æ–°å¢ï¼šä¿®å¤ç”µè„‘ç‰ˆè¾“å…¥æ¡†é—®é¢˜ */
    .clickable-input {
        pointer-events: auto !important;
        cursor: text !important;
    }
    
    /* ä¿®å¤ï¼šé˜²æ­¢å†…å®¹åŒºåŸŸç‚¹å‡»äº‹ä»¶ä¼ æ’­ */
    .content-frame * {
        user-select: text;
    }
    
    /* ä¿®å¤ï¼šè¾“å…¥æ¡†ç‰¹åˆ«æ ·å¼ */
    .password-input input:focus,
    #deficiencyInput input:focus {
        border-color: #667eea !important;
        outline: none !important;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2) !important;
    }
</style>
</head>
<body>
<div class="container">
  <!-- ===== éšè— input ç”¨äºç”µè„‘ scanner ===== -->
  <input type="text" id="scannerInput" autofocus>

  <!-- ===== ç¡®è®¤æ¨¡æ€æ¡† ===== -->
  <div id="confirmationModal" class="modal">
    <div class="modal-content">
        <h3>Confirm Selection</h3>
        <div id="modalMessage" style="text-align: left; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
            <!-- ç¡®è®¤ä¿¡æ¯ä¼šåŠ¨æ€å¡«å……åˆ°è¿™é‡Œ -->
        </div>
        <div class="modal-buttons">
            <button class="modal-btn yes" onclick="confirmSubmit()">Yes</button>
            <button class="modal-btn no" onclick="cancelSubmit()">No</button>
        </div>
    </div>
  </div>

  <!-- ===== é˜¶æ®µ 1ï¼šå›¾çº¸ä¿¡æ¯ ===== -->
  <div id="drawingSection" class="section" style="display:block;">
    <h2>ğŸ“‹ Drawing Information</h2>
    
    <div class="drawing-content">
        <div class="drawing-info">
            <div class="drawing-card">
                <!-- é‡æ–°è®¾è®¡çš„ä¿¡æ¯ç½‘æ ¼å¸ƒå±€ -->
                <div class="form-grid">
                    <div class="form-group">
                        <div class="form-label">Sales Order No.</div>
                        <div class="form-value">SO-009999</div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Item No.</div>
                        <div class="form-value">20</div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Customer Name</div>
                        <div class="form-value">Fujimak</div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Item Name</div>
                        <div class="form-value">S/S Table</div>
                    </div>
                    <div class="form-group full-width">
                        <div class="form-label">Dimension</div>
                        <div class="form-value">L 870mm x W 760mm x H 50mm</div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Quantity</div>
                        <div class="form-value">1</div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Unit of Measurement</div>
                        <div class="form-value">Set</div>
                    </div>
                    <div class="form-group full-width">
                        <div class="form-label">Estimated Delivery Date</div>
                        <div class="form-value">15/01/2025</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="scan-section">
            <div class="scan-instruction">Please scan your <b>Credential QR Code</b></div>
            
            <!-- ç”µè„‘ç‰ˆæ‰«ç æ–¹å¼é€‰æ‹© -->
            <div class="scanner-options" id="scannerOptions" style="display: none;">
                <div class="scanner-method">Choose scanning method:</div>
            </div>
            
            <!-- æ‘„åƒå¤´åˆ‡æ¢æŒ‰é’® -->
            <div class="camera-toggle-container" id="cameraToggleContainer" style="display: none;">
                <button class="camera-toggle-btn" id="cameraToggleBtn">ğŸ“· Use Camera to Scan</button>
            </div>
            
            <!-- æ‘„åƒå¤´æ‰«ææç¤º -->
            <div class="camera-instruction" id="cameraInstruction" style="display: none;">
                Camera mode: Point camera at QR code
            </div>
            
            <div class="scanner-container" id="scannerContainer">
                <div class="dashed-box" id="dashedBox">
                    <div style="font-size: 24px;">ğŸ“±</div>
                    <div>QR Code Scanner Area</div>
                    <div style="font-size: 12px; margin-top: 5px;">è™šçº¿æ¡†æ¡† - æ‰‹æœºæ‰«ç åŒºåŸŸ</div>
                </div>
                <div id="reader"></div>
            </div>

            <div class="gif-container" id="gifContainer">
                <p>Use your scanner to scan the Credential QR Code</p>
                <img src="https://media.giphy.com/media/3o6ZtaO9BZHcOjmErm/giphy.gif" alt="Scanner GIF">
            </div>
        </div>
    </div>
  </div>

  <!-- ===== é˜¶æ®µ 2ï¼šå·¥ä½œæ•°æ®å½•å…¥é¡µé¢ ===== -->
  <div id="workSection" class="section">
    <h2>ğŸ“ Work Data Entry</h2>
    
    <div id="userDisplay">Current User: Cyril</div>
    
    <!-- æ–°å¢ï¼šå›¾çº¸ä¿¡æ¯ä¸²è”æ¡† -->
    <div id="drawingInfoSummary" style="display: none;">
        <!-- è¿™é‡Œå°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
    </div>
    
    <div class="work-main-container">
        <!-- å·¦ä¾§ï¼šå¡ç‰‡é€‰æ‹©åŒºåŸŸ -->
        <div class="cards-section">
            <div class="card-box c1 selected" data-card-index="0">
                <div class="card-english">Received From</div>
                <div class="card-chinese">ä»å“ªæ”¶åˆ°</div>
                <div class="user-selection" id="cardSelection0"></div>
            </div>
            <div class="card-box c2" data-card-index="1">
                <div class="card-english">Job Completed</div>
                <div class="card-chinese">å·²å®Œæˆçš„å·¥ä½œ</div>
                <div class="user-selection" id="cardSelection1"></div>
            </div>
            <div class="card-box c3" data-card-index="2">
                <div class="card-english">Quality Control</div>
                <div class="card-chinese">è´¨é‡æ£€æŸ¥</div>
                <div class="user-selection" id="cardSelection2"></div>
            </div>
        </div>
        
        <!-- ä¸­é—´ï¼šå†…å®¹åŒºåŸŸ -->
        <div class="stack-section">
            <div class="content-frame" id="contentFrame" tabindex="-1">
                <!-- å†…å®¹ä¼šé€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            
            <!-- æäº¤æŒ‰é’® -->
            <div class="submit-section">
                <button id="submitBtn" class="submit-btn">Submit Data</button>
                <div id="successMessage" class="success-message">
                    âœ… Data successfully submitted!
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šLast Userä¿¡æ¯ä¾§è¾¹æ  -->
        <div class="info-sidebar">
            <div class="sidebar-title">Last User Information</div>
            <div class="sidebar-item">
                <div class="sidebar-label">Last User</div>
                <div class="sidebar-value">Cyril</div>
            </div>
            <div class="sidebar-item">
                <div class="sidebar-label">Last User Status</div>
                <div class="sidebar-value">Received From</div>
            </div>
            <div class="sidebar-item">
                <div class="sidebar-label">Last User Selection</div>
                <div class="sidebar-value">Received from Laser Cutting - ä»æ¿€å…‰åˆ‡å‰²éƒ¨æ”¶åˆ°</div>
            </div>
        </div>
    </div>
  </div>
</div>

<script>
function isMobile() {
  return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

// å…¨å±€å˜é‡
let scannerContainer, dashedBox, gifContainer, drawingSection, workSection, scannerInput;
let cameraToggleContainer, cameraToggleBtn, cameraInstruction, scannerOptions;
let drawingInfoSummary;
let currentUser = "";
let currentCardIndex = 0;
let selectedOptions = {
  receivedFrom1: null,
  receivedFrom2: null,
  jobCompleted: null,
  qualityControl: null
};
let isSubmitted = false;
let qcUnlocked = false;
let html5QrcodeScanner = null;
let isCameraActive = false;

// å­˜å‚¨é¡µé¢è¿›å…¥æ—¶çš„åˆå§‹çŠ¶æ€
let initialState = {
  selectedOptions: null,
  currentCardIndex: 0,
  qcUnlocked: false
};

// å­˜å‚¨å›¾çº¸ä¿¡æ¯
let drawingInfo = {
  salesOrder: "SO-009999",
  itemNo: "20",
  customerName: "Fujimak",
  itemName: "S/S Table",
  dimension: "L 870mm x W 760mm x H 50mm",
  quantity: "1",
  unit: "Set",
  deliveryDate: "15/01/2025"
};

// å¡ç‰‡å†…å®¹å’Œiframeæ•°æ® - ä¿®æ”¹ï¼šä¿®å¤é€‰é¡¹å†…å®¹
const cardContents = [
  { // Received From
    title: "Received From ä»å“ªæ”¶åˆ°",
    frames: [
      {
        title: "Received From ä»å“ªæ”¶åˆ°",
        options: [
          {id: "rf1-1", en: "Received 3D Drawing (Completely Stamped)", cn: "æ”¶åˆ°å®Œæ•´ç›–ç« çš„ç«‹ä½“å›¾"},
          {id: "rf1-2", en: "Received Checked 3D Drawing from Supervisor", cn: "ä»å¤´æ‰‹é‚£æ”¶åˆ°å·²æ£€æŸ¥çš„ç«‹ä½“å›¾"},
          {id: "rf1-3", en: "Received 2D Drawing from Drawing Department", cn: "ä»ç»˜å›¾éƒ¨æ”¶åˆ°å±•å¼€å›¾"},
          {id: "rf1-4", en: "Received Checked 2D Drawing from Supervisor", cn: "ä»å¤´æ‰‹é‚£æ”¶åˆ°å·²æ£€æŸ¥çš„å±•å¼€å›¾"},
          {id: "rf1-5", en: "Received Stamped 2D Drawing from Document Control", cn: "ä»æ–‡ä»¶ç®¡ç†éƒ¨æ”¶åˆ°å·²ç›–ç« çš„å±•å¼€å›¾"},
          {id: "rf1-6", en: "Received from Laser Cutting", cn: "ä»æ¿€å…‰åˆ‡å‰²éƒ¨æ”¶åˆ°"},
          {id: "rf1-7", en: "Received from V Cut", cn: "ä»Væ§½åˆ‡å‰²æœºæ”¶åˆ°"},
          {id: "rf1-8", en: "Received from Bending", cn: "ä»å‡¹æ¿éƒ¨æ”¶åˆ°"},
          {id: "rf1-9", en: "Received from Cutting", cn: "ä»åˆ‡å‰²éƒ¨æ”¶åˆ°"},
          {id: "rf1-10", en: "Received from Welding & Assembly", cn: "ä»ç„Šæ¥ä¸ç»„è£…éƒ¨æ”¶åˆ°"},
          {id: "rf1-11", en: "Received from Polishing", cn: "ä»æŠ›å…‰éƒ¨æ”¶åˆ°"},
          {id: "rf1-12", en: "Received from Acid Wash", cn: "ä»åŒ–å­¦æ¸…æ´—éƒ¨æ”¶åˆ°"},
          {id: "rf1-13", en: "Received from Electrical Work", cn: "ä»ç”µå·¥éƒ¨æ”¶åˆ°"},
          {id: "rf1-14", en: "Received from Gas Fitting", cn: "ä»æ¥æ°”ç®¡éƒ¨æ”¶åˆ°"},
          {id: "rf1-15", en: "Received from Plumbing Job", cn: "ä»æ¥æ°´ç®¡éƒ¨æ”¶åˆ°"},
          {id: "rf1-16", en: "Received from Quality Control", cn: "ä»è´¨æ£€éƒ¨æ”¶åˆ°"},
          {id: "rf1-17", en: "Received from Packaging", cn: "ä»åŒ…è£…éƒ¨æ”¶åˆ°"},
          {id: "rf1-18", en: "Received from Finished Goods Labeling", cn: "ä»æˆå“æ ‡ç­¾éƒ¨æ”¶åˆ°"},
          {id: "rf1-19", en: "Received Order from Marketing Department to Deliver Product to Sub-Contractor", cn: "ä»æˆå“æ ‡ç­¾éƒ¨æ”¶åˆ°"},
          {id: "rf1-20", en: "Received Order from Marketing Department to Bring Back Processed Product", cn: "ä»å¸‚åœºéƒ¨æ”¶åˆ°æŒ‡ä»¤æŠŠä»£å·¥/åˆ†åŒ…å•†å¤„ç†å¥½çš„äº§å“æ‹¿å›æ¥"},
          {id: "rf1-21", en: "Received Product from Sub Contractor", cn: "ä»ä»£å·¥/åˆ†åŒ…å•†æ”¶åˆ°äº§å“"}
        ]
      },
      {
        title: "Check æ£€æŸ¥",
        options: [
          {id: "rf2-1", en: "Pass", cn: "è¿‡å…³"},
          {id: "rf2-2", en: "Deficiencies", cn: "ä¸è¶³ä¹‹å¤„"}
        ],
        hasInput: true
      }
    ]
  },
  { // Job Completed - ä¿®æ”¹ï¼šä¿®å¤é€‰é¡¹å†…å®¹
    title: "Job Completed å·²å®Œæˆçš„å·¥ä½œ",
    frames: [
      {
        title: "Job Completed å·²å®Œæˆçš„å·¥ä½œ",
        options: [
          {id: "jc1-1", en: "QR Code Creation", cn: "äºŒç»´ç åˆ›å»º"},
          {id: "jc1-2", en: "Document Control: Checked & Stamped", cn: "æ–‡ä»¶ç®¡ç†: æ£€æŸ¥ç›–ç« "},
          {id: "jc1-3", en: "Project Department: Explained & Passed Drawing", cn: "é¡¹ç›®éƒ¨: è®²è§£ & ä¸‹å›¾"},
          {id: "jc1-4", en: "Supervisor: Checked 3D Drawing", cn: "å¤´æ‰‹: å®Œæˆç«‹ä½“å›¾çš„æ£€æŸ¥"},
          {id: "jc1-5", en: "2D Drawing", cn: "å±•å¼€å›¾"},
          {id: "jc1-6", en: "Supervisor: Checked 2D Drawing & Signed", cn: "å¤´æ‰‹: å®Œæˆå±•å¼€å›¾çš„æ£€æŸ¥å¹¶ç­¾å"}, // ä¿®æ”¹ï¼šChanged to "Supervisor: Checked 2D Drawing & Signed"
          {id: "jc1-7", en: "Laser Cutting", cn: "æ¿€å…‰åˆ‡å‰²"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-8", en: "V Cut", cn: "Væ§½åˆ‡å‰²"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-9", en: "Bending", cn: "å‡¹æ¿"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-10", en: "Cutting", cn: "åˆ‡å‰²"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-11", en: "Welding & Assembly", cn: "ç„Šæ¥ä¸ç»„è£…"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-12", en: "Painting", cn: "ä¸Šæ¼†"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-13", en: "Polishing", cn: "æŠ›å…‰"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-14", en: "Acid Wash", cn: "åŒ–å­¦æ¸…æ´—"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-15", en: "Electrical Work", cn: "ç”µå·¥"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-16", en: "Gas Fitting", cn: "æ°”ç®¡å·¥"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-17", en: "Plumbing Job", cn: "æ°´ç®¡å·¥"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-18", en: "Quality Control", cn: "è´¨æ£€"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-19", en: "Packaging", cn: "åŒ…è£…"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-20", en: "Finished Goods Labeling", cn: "ç»™æˆå“è´´æ ‡ç­¾"}, // ä¿®æ”¹ï¼šç§»é™¤"Skip to question 29"
          {id: "jc1-21", en: "Deliver Product to Sub-Contractor", cn: "é€äº§å“åˆ°ä»£å·¥/åˆ†åŒ…å•†"},
          {id: "jc1-22", en: "Bring Back Processed Product from Sub-Contractor", cn: "ä»ä»£å·¥/åˆ†åŒ…å•†æ‹¿å›å¤„ç†å¥½çš„äº§å“"},
          {id: "jc1-23", en: "Shipping Out", cn: "å‡ºè´§"}
          // ä¿®æ”¹ï¼šç§»é™¤"QC, Marketing & Supervisor U"é€‰é¡¹
        ]
      }
    ]
  },
  { // Quality Control
    title: "Quality Control è´¨é‡æ£€æŸ¥",
    frames: [
      {
        title: "Quality Control è´¨é‡æ£€æŸ¥",
        options: [
          {id: "qc1-1", en: "Visual Inspection Passed", cn: "ç›®è§†æ£€æŸ¥é€šè¿‡"},
          {id: "qc1-2", en: "Measurement Check Completed", cn: "å°ºå¯¸æ£€æŸ¥å®Œæˆ"},
          {id: "qc1-3", en: "Documentation Verified", cn: "æ–‡ä»¶éªŒè¯å®Œæˆ"}
        ],
        locked: true
      }
    ]
  }
];

function handleCredentialScan(user) {
  // åœæ­¢æ‘„åƒå¤´æ‰«æï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
  if (isCameraActive && html5QrcodeScanner) {
    stopCameraScanner();
  }
  
  // éšè—å›¾çº¸ä¿¡æ¯ï¼Œæ˜¾ç¤ºå·¥ä½œæ•°æ®å½•å…¥é¡µé¢
  drawingSection.style.display = "none";
  workSection.style.display = "block";
  currentUser = user;
  document.getElementById("userDisplay").textContent = `Current User: ${user}`;
  
  // æ˜¾ç¤ºå¹¶æ›´æ–°å›¾çº¸ä¿¡æ¯ä¸²è”æ¡†
  updateDrawingInfoSummary();
  drawingInfoSummary.style.display = "block";
  
  // é‡ç½®æ‰€æœ‰é€‰æ‹©çŠ¶æ€
  clearAllSelections();
  
  // ä¿å­˜åˆå§‹çŠ¶æ€ï¼ˆæ‰€æœ‰æœªé€‰æ‹©çš„çŠ¶æ€ï¼‰
  saveInitialState();
  
  // åˆå§‹åŒ–å¡ç‰‡
  initCards();
  renderCardContent();
  
  // åˆå§‹åŒ–æ»šåŠ¨è·Ÿéšæ•ˆæœï¼ˆç”µè„‘ç‰ˆï¼‰
  if (!isMobile()) {
    initScrollFollow();
  }
}

// ä¿å­˜åˆå§‹çŠ¶æ€
function saveInitialState() {
  initialState = {
    selectedOptions: JSON.parse(JSON.stringify(selectedOptions)), // æ·±æ‹·è´
    currentCardIndex: currentCardIndex,
    qcUnlocked: qcUnlocked
  };
}

// é‡ç½®åˆ°åˆå§‹çŠ¶æ€
function resetToInitialState() {
  selectedOptions = JSON.parse(JSON.stringify(initialState.selectedOptions));
  currentCardIndex = initialState.currentCardIndex;
  qcUnlocked = initialState.qcUnlocked;
  
  updateCardSelection();
  updateCardUserSelections();
  renderCardContent();
  updateSubmitButton();
}

// æ›´æ–°å›¾çº¸ä¿¡æ¯ä¸²è”æ¡†
function updateDrawingInfoSummary() {
  const summary = `${drawingInfo.salesOrder} - ${drawingInfo.itemName} (${drawingInfo.customerName}) - Qty: ${drawingInfo.quantity} ${drawingInfo.unit} - ${drawingInfo.dimension} - EDD: ${drawingInfo.deliveryDate}`;
  drawingInfoSummary.textContent = summary;
}

// åˆå§‹åŒ–å¡ç‰‡é€‰æ‹© - ä¿®å¤ç‰ˆ
function initCards() {
  const cards = document.querySelectorAll('.card-box');
  
  cards.forEach(card => {
    card.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const newIndex = parseInt(this.getAttribute('data-card-index'));
      
      if (newIndex === currentCardIndex) {
        return;
      }
      
      // è‡ªåŠ¨æ¸…é™¤ä¹‹å‰é¡µé¢çš„é€‰æ‹©
      clearOtherPagesSelections(newIndex);
      
      // æ›´æ–°å½“å‰å¡ç‰‡ç´¢å¼•
      currentCardIndex = newIndex;
      
      // æ›´æ–°å¡ç‰‡é€‰æ‹©çŠ¶æ€
      updateCardSelection();
      
      // æ›´æ–°å¡ç‰‡ä¸Šçš„ç”¨æˆ·é€‰æ‹©æ˜¾ç¤º
      updateCardUserSelections();
      
      // æ¸²æŸ“æ–°å¡ç‰‡å†…å®¹
      renderCardContent();
    });
  });
  
  // åˆå§‹æ›´æ–°å¡ç‰‡é€‰æ‹©çŠ¶æ€
  updateCardSelection();
  updateCardUserSelections();
}

// æ¸…é™¤å…¶ä»–é¡µé¢çš„é€‰æ‹©
function clearOtherPagesSelections(newPageIndex) {
  // æ¸…é™¤ä¸æ˜¯å½“å‰é¡µé¢çš„æ‰€æœ‰é€‰æ‹©
  if (newPageIndex !== 0) {
    selectedOptions.receivedFrom1 = null;
    selectedOptions.receivedFrom2 = null;
  }
  
  if (newPageIndex !== 1) {
    selectedOptions.jobCompleted = null;
  }
  
  if (newPageIndex !== 2) {
    selectedOptions.qualityControl = null;
    qcUnlocked = false; // é‡ç½®QCè§£é”çŠ¶æ€
  }
  
  // æ›´æ–°å¡ç‰‡ä¸Šçš„ç”¨æˆ·é€‰æ‹©æ˜¾ç¤º
  updateCardUserSelections();
}

// æ›´æ–°å¡ç‰‡é€‰æ‹©çŠ¶æ€
function updateCardSelection() {
  const cards = document.querySelectorAll('.card-box');
  
  cards.forEach((card, index) => {
    // ç§»é™¤æ‰€æœ‰é€‰æ‹©çŠ¶æ€
    card.classList.remove('selected');
    
    // å½“å‰é€‰ä¸­çš„å¡ç‰‡
    if (index === currentCardIndex) {
      card.classList.add('selected');
    }
  });
}

// æ›´æ–°å¡ç‰‡ä¸Šçš„ç”¨æˆ·é€‰æ‹©æ˜¾ç¤º - ä¿®æ”¹ï¼šç§»é™¤"Received"å’Œ"Received from"å­—æ ·
function updateCardUserSelections() {
  // Received From
  if (selectedOptions.receivedFrom1 && selectedOptions.receivedFrom2) {
    const option1 = getOptionTextShort(selectedOptions.receivedFrom1);
    const option2 = getOptionTextShort(selectedOptions.receivedFrom2);
    document.getElementById('cardSelection0').textContent = `${option1} / ${option2}`;
  } else {
    // ä¿®æ”¹ï¼šä¸æ˜¾ç¤º"No selection"ï¼Œç•™ç©º
    document.getElementById('cardSelection0').textContent = '';
  }
  
  // Job Completed
  if (selectedOptions.jobCompleted) {
    const option = getOptionTextShort(selectedOptions.jobCompleted);
    document.getElementById('cardSelection1').textContent = option;
  } else {
    // ä¿®æ”¹ï¼šä¸æ˜¾ç¤º"No selection"ï¼Œç•™ç©º
    document.getElementById('cardSelection1').textContent = '';
  }
  
  // Quality Control
  if (selectedOptions.qualityControl) {
    const option = getOptionTextShort(selectedOptions.qualityControl);
    document.getElementById('cardSelection2').textContent = option;
  } else {
    // ä¿®æ”¹ï¼šä¸æ˜¾ç¤º"No selection"ï¼Œç•™ç©º
    document.getElementById('cardSelection2').textContent = '';
  }
}

// è·å–é€‰é¡¹æ–‡æœ¬ï¼ˆç®€çŸ­ç‰ˆï¼‰- ä¿®æ”¹ï¼šæ›´å¥½çš„ç§»é™¤"Received"å’Œ"Received from"å­—æ ·é€»è¾‘
function getOptionTextShort(optionId) {
  if (!optionId) return "";
  
  // åœ¨æ‰€æœ‰å¡ç‰‡å†…å®¹ä¸­æŸ¥æ‰¾é€‰é¡¹
  for (let card of cardContents) {
    for (let frame of card.frames) {
      for (let option of frame.options) {
        if (option.id === optionId) {
          let text = option.en;
          
          // ä¿®æ”¹ï¼šæ›´ç²¾ç¡®åœ°ç§»é™¤"Received"å’Œ"Received from"å­—æ ·
          // å…ˆæ£€æŸ¥æ˜¯å¦æœ‰"Received from"ï¼Œæœ‰å°±ä¸€èµ·ç§»é™¤
          if (text.toLowerCase().startsWith("received from ")) {
            text = text.substring("Received from ".length);
          } 
          // ç„¶åæ£€æŸ¥æ˜¯å¦è¿˜æœ‰å•ç‹¬çš„"Received "ï¼ˆæ³¨æ„ç©ºæ ¼ï¼‰
          else if (text.toLowerCase().startsWith("received ")) {
            text = text.substring("Received ".length);
          }
          
          // ä¿®æ”¹ï¼šè¿”å›å‰25ä¸ªå­—ç¬¦ï¼ˆä¹‹å‰æ˜¯20ä¸ªï¼Œå¢åŠ 5ä¸ªï¼‰
          return text.length > 25 ? text.substring(0, 25) + '...' : text;
        }
      }
    }
  }
  return optionId;
}

// æ£€æŸ¥ç‰¹å®šå¡ç‰‡æ˜¯å¦æœ‰é€‰æ‹©
function hasSelectionInCard(cardIndex) {
  if (cardIndex === 0) { // Received From
    return selectedOptions.receivedFrom1 && selectedOptions.receivedFrom2;
  } else if (cardIndex === 1) { // Job Completed
    return selectedOptions.jobCompleted !== null;
  } else if (cardIndex === 2) { // Quality Control
    return selectedOptions.qualityControl !== null;
  }
  return false;
}

// æ£€æŸ¥å½“å‰å¡ç‰‡æ˜¯å¦æœ‰é€‰æ‹©
function hasSelectionInCurrentCard() {
  return hasSelectionInCard(currentCardIndex);
}

// æ¸…é™¤æ‰€æœ‰é€‰æ‹©
function clearAllSelections() {
  selectedOptions = {
    receivedFrom1: null,
    receivedFrom2: null,
    jobCompleted: null,
    qualityControl: null
  };
  
  // é‡ç½®QCè§£é”çŠ¶æ€
  qcUnlocked = false;
  
  // é‡ç½®å½“å‰å¡ç‰‡ç´¢å¼•
  currentCardIndex = 0;
  
  // é‡ç½®æäº¤çŠ¶æ€
  isSubmitted = false;
  const submitBtn = document.getElementById('submitBtn');
  if (submitBtn) submitBtn.disabled = false;
  
  const successMessage = document.getElementById('successMessage');
  if (successMessage) successMessage.style.display = 'none';
  
  // æ›´æ–°å¡ç‰‡ä¸Šçš„ç”¨æˆ·é€‰æ‹©æ˜¾ç¤º
  updateCardUserSelections();
}

// å¯åŠ¨æ‘„åƒå¤´æ‰«æ
function startCameraScanner() {
  if (html5QrcodeScanner) {
    return;
  }
  
  // æ¸…é™¤è™šçº¿æ¡†æ¡†
  dashedBox.style.display = "none";
  gifContainer.style.display = "none";
  
  // åˆ›å»ºæ‘„åƒå¤´æ‰«æå™¨
  html5QrcodeScanner = new Html5Qrcode("reader");
  
  // å¯åŠ¨æ‘„åƒå¤´
  html5QrcodeScanner.start(
    { facingMode: "environment" },
    { 
      fps: 10, 
      qrbox: { width: 180, height: 180 }
    },
    (decodedText) => {
      console.log("Camera scanned:", decodedText);
      if (decodedText === "Cyril") {
        handleCredentialScan("Cyril");
      } else {
        alert("Unknown user QR. Please scan a valid credential.");
      }
    },
    (errorMessage) => {
      // å¿½ç•¥è§£æé”™è¯¯
    }
  ).catch(err => {
    console.error("Camera error:", err);
    alert("Camera initialization failed. Please check camera permissions.");
    stopCameraScanner();
  });
  
  // æ›´æ–°UIçŠ¶æ€
  isCameraActive = true;
  cameraToggleBtn.textContent = "âŒ Stop Camera";
  cameraToggleBtn.classList.add("stop");
  cameraInstruction.style.display = "block";
}

// åœæ­¢æ‘„åƒå¤´æ‰«æ
function stopCameraScanner() {
  if (html5QrcodeScanner && isCameraActive) {
    html5QrcodeScanner.stop().then(() => {
      console.log("Camera stopped");
      html5QrcodeScanner.clear();
      html5QrcodeScanner = null;
      
      // æ¢å¤è™šçº¿æ¡†æ¡†
      dashedBox.style.display = "flex";
      gifContainer.style.display = "block";
      
      // æ›´æ–°UIçŠ¶æ€
      isCameraActive = false;
      cameraToggleBtn.textContent = "ğŸ“· Use Camera to Scan";
      cameraToggleBtn.classList.remove("stop");
      cameraInstruction.style.display = "none";
      
      // é‡æ–°èšç„¦åˆ°æ‰«æä»ªè¾“å…¥æ¡†
      scannerInput.focus();
    }).catch(err => {
      console.error("Stop camera error:", err);
    });
  }
}

// æ‘„åƒå¤´åˆ‡æ¢æŒ‰é’®äº‹ä»¶
function toggleCameraScanner() {
  if (!isCameraActive) {
    startCameraScanner();
  } else {
    stopCameraScanner();
  }
}

// æ¸²æŸ“å¡ç‰‡å†…å®¹
function renderCardContent() {
  const contentFrame = document.getElementById('contentFrame');
  const currentCard = cardContents[currentCardIndex];
  
  let contentHTML = `<div class="frame-title">${currentCard.title}</div>`;
  
  if (currentCardIndex === 0) { // Received From
    contentHTML += `
      <div style="margin-bottom: 25px;">
        <div style="font-weight: 600; margin-bottom: 10px; color: #333;">${currentCard.frames[0].title}:</div>
        ${renderOptions(currentCard.frames[0].options, 'receivedFrom1')}
      </div>
      <div>
        <div style="font-weight: 600; margin-bottom: 10px; color: #333;">${currentCard.frames[1].title}:</div>
        ${renderOptions(currentCard.frames[1].options, 'receivedFrom2')}
        ${currentCard.frames[1].hasInput ? `
          <div id="deficiencyInput" style="margin-top: 15px; display: none;">
            <div style="margin-bottom: 8px; font-weight: 500; color: #555;">Deficiency Details (ä¸è¶³ä¹‹å¤„è¯¦æƒ…):</div>
            <input type="text" id="deficiencyText" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="Enter deficiency details here...">
          </div>
        ` : ''}
      </div>
    `;
  } else if (currentCardIndex === 1) { // Job Completed
    contentHTML += `
      <div>
        ${renderOptions(currentCard.frames[0].options, 'jobCompleted')}
      </div>
    `;
  } else if (currentCardIndex === 2) { // Quality Control
    if (!qcUnlocked) {
      contentHTML += `
        <div style="text-align: center; padding: 40px 20px;">
          <div style="font-size: 18px; color: #666; margin-bottom: 20px;">Quality Control section is locked</div>
          <div class="password-section">
            <div style="margin-bottom: 10px; color: #555;">Enter password to unlock:</div>
            <div class="password-input">
              <input type="password" id="qcPassword" placeholder="Enter password..." class="clickable-input">
              <button onclick="checkQCPassword()">Unlock</button>
            </div>
            <div id="passwordError" style="color: #e74c3c; margin-top: 10px; display: none;">Incorrect password. Try again.</div>
          </div>
        </div>
      `;
    } else {
      contentHTML += `
        <div>
          ${renderOptions(currentCard.frames[0].options, 'qualityControl')}
        </div>
      `;
    }
  }
  
  contentFrame.innerHTML = contentHTML;
  
  // æ·»åŠ é€‰é¡¹é€‰æ‹©äº‹ä»¶ç›‘å¬
  addOptionListeners();
  
  // æ¢å¤å·²é€‰æ‹©çš„é€‰é¡¹
  restoreSelectedOptions();
  
  // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
  updateSubmitButton();
}

// æ¸²æŸ“é€‰é¡¹åˆ—è¡¨ - ä½¿ç”¨å®Œå…¨è‡ªå®šä¹‰çš„radioæŒ‰é’®
function renderOptions(options, category) {
  let html = '';
  options.forEach(option => {
    const isSelected = selectedOptions[category] === option.id;
    html += `
      <div class="option-item ${isSelected ? 'selected' : ''}" data-id="${option.id}" data-category="${category}">
        <div class="custom-radio ${isSelected ? 'selected' : ''}" data-for="${option.id}"></div>
        <div class="option-label">
          <div class="option-english">${option.en}</div>
          <div class="option-chinese">${option.cn}</div>
        </div>
      </div>
    `;
  });
  return html;
}

// æ·»åŠ é€‰é¡¹é€‰æ‹©äº‹ä»¶ç›‘å¬ - ä¿®å¤ç‰ˆï¼ˆå®Œå…¨ä¸ä¼šè·³è½¬ï¼‰
function addOptionListeners() {
  // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ‰€æœ‰é€‰é¡¹ç‚¹å‡»
  document.addEventListener('click', function(e) {
    // å¤„ç†é€‰é¡¹é¡¹ç‚¹å‡»
    let optionItem = e.target.closest('.option-item');
    if (!optionItem && e.target.classList.contains('custom-radio')) {
      optionItem = e.target.closest('.option-item');
    }
    
    if (optionItem) {
      e.preventDefault();
      e.stopPropagation();
      
      const optionId = optionItem.getAttribute('data-id');
      const category = optionItem.getAttribute('data-category');
      
      // æ›´æ–°é€‰æ‹©
      selectedOptions[category] = optionId;
      
      // æ›´æ–°é€‰é¡¹æ ·å¼
      updateOptionStyles(category, optionId);
      
      // å¦‚æœæ˜¯Deficienciesé€‰é¡¹ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
      if (optionId === 'rf2-2') {
        const deficiencyInput = document.getElementById('deficiencyInput');
        if (deficiencyInput) {
          deficiencyInput.style.display = 'block';
          // å»¶è¿Ÿèšç„¦ä»¥ç¡®ä¿è¾“å…¥æ¡†å·²æ˜¾ç¤º
          setTimeout(() => {
            const deficiencyText = document.getElementById('deficiencyText');
            if (deficiencyText) {
              deficiencyText.focus();
            }
          }, 50);
        }
      } else if (category === 'receivedFrom2') {
        const deficiencyInput = document.getElementById('deficiencyInput');
        if (deficiencyInput) deficiencyInput.style.display = 'none';
      }
      
      // æ›´æ–°å¡ç‰‡ä¸Šçš„ç”¨æˆ·é€‰æ‹©æ˜¾ç¤º
      updateCardUserSelections();
      
      // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
      updateSubmitButton();
      
      return false; // é˜²æ­¢é»˜è®¤è¡Œä¸º
    }
  });
  
  // ä¿®å¤ç”µè„‘ç‰ˆè¾“å…¥é—®é¢˜ - ç¡®ä¿è¾“å…¥æ¡†å¯ä»¥æ¥æ”¶ç‚¹å‡»äº‹ä»¶
  document.addEventListener('mousedown', function(e) {
    if (e.target.id === 'qcPassword' || e.target.id === 'deficiencyText') {
      e.stopPropagation();
      e.preventDefault();
      // ç«‹å³èšç„¦åˆ°è¾“å…¥æ¡†
      e.target.focus();
    }
  }, true);
  
  document.addEventListener('click', function(e) {
    if (e.target.id === 'qcPassword' || e.target.id === 'deficiencyText') {
      e.stopPropagation();
    }
  }, true);
  
  // å¤„ç†è§£é”æŒ‰é’®ç‚¹å‡»
  document.addEventListener('click', function(e) {
    if (e.target.tagName === 'BUTTON' && e.target.textContent.includes('Unlock')) {
      e.preventDefault();
      e.stopPropagation();
      checkQCPassword();
      return false;
    }
  });
}

// æ›´æ–°é€‰é¡¹æ ·å¼
function updateOptionStyles(category, selectedId) {
  // é‡ç½®æ‰€æœ‰è¯¥åˆ†ç±»çš„é€‰é¡¹æ ·å¼
  document.querySelectorAll(`.option-item[data-category="${category}"]`).forEach(item => {
    item.classList.remove('selected');
    const radio = item.querySelector('.custom-radio');
    if (radio) radio.classList.remove('selected');
  });
  
  // é€‰ä¸­çš„æ·»åŠ æ ·å¼
  const selectedItem = document.querySelector(`.option-item[data-id="${selectedId}"]`);
  if (selectedItem) {
    selectedItem.classList.add('selected');
    const radio = selectedItem.querySelector('.custom-radio');
    if (radio) radio.classList.add('selected');
  }
}

// æ¢å¤å·²é€‰æ‹©çš„é€‰é¡¹
function restoreSelectedOptions() {
  Object.keys(selectedOptions).forEach(category => {
    const optionId = selectedOptions[category];
    if (optionId) {
      updateOptionStyles(category, optionId);
      
      if (optionId === 'rf2-2') {
        const deficiencyInput = document.getElementById('deficiencyInput');
        if (deficiencyInput) deficiencyInput.style.display = 'block';
      }
    }
  });
}

// æ£€æŸ¥QCå¯†ç 
function checkQCPassword() {
  const passwordInput = document.getElementById('qcPassword');
  const passwordError = document.getElementById('passwordError');
  
  if (passwordInput && passwordInput.value === '1234') {
    qcUnlocked = true;
    renderCardContent();
  } else {
    if (passwordError) passwordError.style.display = 'block';
    if (passwordInput) passwordInput.value = '';
  }
}

// è·å–é¡µé¢åç§°
function getPageName(cardIndex) {
  switch(cardIndex) {
    case 0: return "Received From";
    case 1: return "Job Completed";
    case 2: return "Quality Control";
    default: return "Unknown";
  }
}

// è·å–é€‰é¡¹æ–‡æœ¬ï¼ˆå®Œæ•´ç‰ˆï¼‰
function getOptionText(optionId) {
  if (!optionId) return "Not selected";
  
  // åœ¨æ‰€æœ‰å¡ç‰‡å†…å®¹ä¸­æŸ¥æ‰¾é€‰é¡¹
  for (let card of cardContents) {
    for (let frame of card.frames) {
      for (let option of frame.options) {
        if (option.id === optionId) {
          return `${option.en} (${option.cn})`;
        }
      }
    }
  }
  return optionId;
}

// æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
function updateSubmitButton() {
  const submitBtn = document.getElementById('submitBtn');
  
  // æ£€æŸ¥å½“å‰å¡ç‰‡æ˜¯å¦æœ‰é€‰æ‹©
  const hasSelection = hasSelectionInCurrentCard();
  
  submitBtn.disabled = !hasSelection || isSubmitted;
}

// æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡† - ä¿®æ”¹ï¼šè°ƒæ•´æ˜¾ç¤ºé¡ºåº
function showConfirmationModal() {
  if (isSubmitted) return;
  
  // æ£€æŸ¥æ˜¯å¦æœ‰é€‰æ‹©
  const hasSelection = hasSelectionInCurrentCard();
  if (!hasSelection) {
    alert("Please make a selection before submitting.");
    return;
  }
  
  // æ„å»ºç¡®è®¤æ¶ˆæ¯ - ä¿®æ”¹ï¼šå…ˆæ˜¾ç¤ºDrawing Infoï¼Œå†æ˜¾ç¤ºCurrent Userå’ŒCurrent Page
  let confirmationMessage = `<p><strong>Drawing Info:</strong> ${drawingInfoSummary.textContent}</p>`;
  confirmationMessage += `<p><strong>Current User:</strong> ${currentUser}</p>`;
  confirmationMessage += `<p><strong>Current Page:</strong> ${getPageName(currentCardIndex)}</p>`;
  confirmationMessage += `<hr style="margin: 15px 0; border: 0; border-top: 1px solid #ddd;">`;
  
  // æ·»åŠ é€‰æ‹©è¯¦æƒ…
  if (currentCardIndex === 0) { // Received From
    const option1 = getOptionText(selectedOptions.receivedFrom1);
    const option2 = getOptionText(selectedOptions.receivedFrom2);
    confirmationMessage += `<p><strong>1. Received From:</strong> ${option1}</p>`;
    confirmationMessage += `<p><strong>2. Check:</strong> ${option2}</p>`;
    
    // å¦‚æœæœ‰Deficienciesè¯¦æƒ…ï¼Œä¹Ÿæ˜¾ç¤º
    if (selectedOptions.receivedFrom2 === 'rf2-2') {
      const deficiencyText = document.getElementById('deficiencyText');
      if (deficiencyText && deficiencyText.value) {
        confirmationMessage += `<p><strong>Deficiency Details:</strong> ${deficiencyText.value}</p>`;
      }
    }
  } else if (currentCardIndex === 1) { // Job Completed
    const option = getOptionText(selectedOptions.jobCompleted);
    confirmationMessage += `<p><strong>Selected:</strong> ${option}</p>`;
  } else if (currentCardIndex === 2) { // Quality Control
    const option = getOptionText(selectedOptions.qualityControl);
    confirmationMessage += `<p><strong>Selected:</strong> ${option}</p>`;
  }
  
  confirmationMessage += `<hr style="margin: 15px 0; border: 0; border-top: 1px solid #ddd;">`;
  confirmationMessage += `<p style="text-align: center; font-weight: bold;">Is this information correct?</p>`;
  
  // å¡«å……æ¨¡æ€æ¡†å†…å®¹
  document.getElementById('modalMessage').innerHTML = confirmationMessage;
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†
  document.getElementById('confirmationModal').style.display = 'flex';
}

// ç¡®è®¤æäº¤
function confirmSubmit() {
  // éšè—æ¨¡æ€æ¡†
  document.getElementById('confirmationModal').style.display = 'none';
  
  const successMessage = document.getElementById('successMessage');
  const submitBtn = document.getElementById('submitBtn');
  
  // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
  successMessage.style.display = 'block';
  
  // ç¦ç”¨æäº¤æŒ‰é’®
  submitBtn.disabled = true;
  isSubmitted = true;
  
  // è®°å½•æäº¤æ•°æ®
  console.log('Data submitted:', {
    user: currentUser,
    cardIndex: currentCardIndex,
    selectedOptions: selectedOptions,
    timestamp: new Date().toISOString()
  });
}

// å–æ¶ˆæäº¤
function cancelSubmit() {
  // éšè—æ¨¡æ€æ¡†
  document.getElementById('confirmationModal').style.display = 'none';
  
  // é‡ç½®åˆ°åˆå§‹çŠ¶æ€
  resetToInitialState();
  alert("Selection has been reset. Please make your choice again.");
}

// æäº¤æ•°æ®ï¼ˆç°åœ¨åªæ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†ï¼‰
function submitData() {
  showConfirmationModal();
}

// åˆå§‹åŒ–æ»šåŠ¨è·Ÿéšæ•ˆæœï¼ˆç”µè„‘ç‰ˆï¼‰ - ä¿®æ”¹ï¼šä¸éœ€è¦ç›‘å¬iframeæ»šåŠ¨ï¼Œå› ä¸ºiframeä¸å†å¯æ»šåŠ¨
function initScrollFollow() {
  const cardsSection = document.querySelector('.cards-section');
  const infoSidebar = document.querySelector('.info-sidebar');
  
  if (!cardsSection || !infoSidebar) return;
  
  // å­˜å‚¨åˆå§‹topä½ç½®
  const initialTop = 20;
  
  // ç›‘å¬æ•´ä¸ªé¡µé¢çš„æ»šåŠ¨
  window.addEventListener('scroll', function() {
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const containerTop = document.querySelector('.container').offsetTop;
    
    // è®¡ç®—ç›¸å¯¹æ»šåŠ¨ä½ç½®
    const relativeScroll = Math.max(0, scrollTop - containerTop);
    
    // è®¡ç®—æ–°çš„topä½ç½®
    let newTop = initialTop + Math.min(relativeScroll, 100); // é™åˆ¶æœ€å¤§æ»šåŠ¨è·Ÿéšè·ç¦»
    
    // åº”ç”¨æ–°çš„topä½ç½®
    cardsSection.style.top = newTop + 'px';
    infoSidebar.style.top = newTop + 'px';
  });
}

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  scannerContainer = document.getElementById("scannerContainer");
  dashedBox = document.getElementById("dashedBox");
  gifContainer = document.getElementById("gifContainer");
  drawingSection = document.getElementById("drawingSection");
  workSection = document.getElementById("workSection");
  scannerInput = document.getElementById("scannerInput");
  drawingInfoSummary = document.getElementById("drawingInfoSummary");
  
  // æ–°å¢å…ƒç´ 
  cameraToggleContainer = document.getElementById("cameraToggleContainer");
  cameraToggleBtn = document.getElementById("cameraToggleBtn");
  cameraInstruction = document.getElementById("cameraInstruction");
  scannerOptions = document.getElementById("scannerOptions");
  
  // ç»‘å®šæäº¤æŒ‰é’®äº‹ä»¶
  document.getElementById('submitBtn').addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    submitData();
  });
  
  // ç»‘å®šæ‘„åƒå¤´åˆ‡æ¢æŒ‰é’®äº‹ä»¶
  cameraToggleBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    toggleCameraScanner();
  });
  
  if (isMobile()) {
    // æ‰‹æœºç‰ˆè°ƒæ•´å¸ƒå±€
    const infoSidebar = document.querySelector('.info-sidebar');
    const cardsSection = document.querySelector('.cards-section');
    
    // é‡æ–°æ’åˆ—DOMé¡ºåº
    if (infoSidebar && cardsSection) {
      const workMainContainer = document.querySelector('.work-main-container');
      workMainContainer.insertBefore(infoSidebar, cardsSection);
    }
    
    // æ‰‹æœºæ‰“å¼€ï¼Œæ˜¾ç¤ºæ‘„åƒå¤´æ‰«ç 
    scannerContainer.style.display = "block";
    dashedBox.style.display = "none";
    gifContainer.style.display = "none";
    
    const html5QrcodeScanner = new Html5Qrcode("reader");

    html5QrcodeScanner.start(
      { facingMode: "environment" },
      { 
        fps: 10, 
        qrbox: { width: 250, height: 250 }
      },
      (decodedText) => {
        console.log("Scanned:", decodedText);
        if(decodedText === "Cyril") {
          html5QrcodeScanner.stop();
          handleCredentialScan("Cyril");
        } else {
          alert("Unknown user QR. Please scan a valid credential.");
        }
      }
    ).catch(err => {
      console.error(err);
      alert("Camera initialization failed. Please check camera permissions.");
    });

  } else {
    // ç”µè„‘æ‰“å¼€ï¼Œæ˜¾ç¤ºè™šçº¿æ¡†æ¡†å’ŒGIFæç¤º
    scannerContainer.style.display = "block";
    dashedBox.style.display = "flex";
    gifContainer.style.display = "block";
    
    // æ˜¾ç¤ºç”µè„‘ç‰ˆä¸“å±UIå…ƒç´ 
    cameraToggleContainer.style.display = "block";
    scannerOptions.style.display = "block";

    // æ¯æ¬¡ç‚¹å‡»é¡µé¢éƒ½ focus éšè—è¾“å…¥æ¡†ï¼Œä¿è¯ scanner è¾“å…¥èƒ½æ•è·
    document.addEventListener("click", () => scannerInput.focus());

    // ç›‘å¬ scanner è¾“å…¥
    scannerInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter") {
        const value = scannerInput.value.trim();
        scannerInput.value = "";
        if(value === "Cyril") {
          handleCredentialScan("Cyril");
        } else {
          alert("Unknown user. Please scan a valid credential QR code.");
        }
      }
    });

    // é¡µé¢åŠ è½½åè‡ªåŠ¨ focus è¾“å…¥æ¡†
    window.onload = () => {
      scannerInput.focus();
    };
  }
});
</script>
</body>
</html>
